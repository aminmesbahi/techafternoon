<div dir="rtl">

# مثال پیاده‌سازی RAG با استفاده از Semantic Kernel در قالب پردازش نرخ ارز

توی این مثال نشون می‌دیم که چطوری با استفاده از Semantic Kernel، یک سیستم پرسش و پاسخ پیاده‌سازی کنیم که داده‌هاش محدود به داده‌های مدل مورد استفاده‌مون (اینجا llama3.2) نباشه. در حقیقت این مثال یک نمونه ساده از پیاده‌سازی RAG در مدل‌های زبانی است. توی این مثال، از یک مدل چت (Ollama با مدل llama3.2:3b) استفاده می‌کنیم. اول، به‌صورت مستقیم و مبتنی بر داده‌های خود مدل به سوال کاربر پاسخ می‌ده که می‌بینیم پاسخ بی‌ربط و قدیمی و بی‌اعتباری می‌ده. بعد، با استفاده از تکنیک RAG یا Retrieval Augmented Generation و حافظه (semantic memory)، داده‌های خودمون رو هم در اختیارش قرار می‌دیم، و می‌بینیم پاسخ به‌روز و صحیح تولید می‌کنه.

---

## معرفی Semantic Kernel

Semantic Kernel یک فریم‌ورکه که امکان یکپارچه‌سازی مدل‌های زبان بزرگ (LLM) رو در برنامه‌های کاربردی فراهم می‌کنه. این فریم‌ورک:

- امکان استفاده از Chat Completion برای تولید پاسخ‌های تعاملی رو فرهم می‌کنه.  
- با استفاده از Embeddingها، داده‌ها را به یک فضای معنایی نگاشت می‌کنه.  
- با پشتیبانی از پلاگین‌ها، قابلیت‌های اضافی مثل حافظه رو به برنامه اضافه می‌کنه.  
- امکان یکپارچگی و توسعه با دات‌نت، پایتون و جاوا رو هم داره.


برای اطلاعات بیشتر می‌تونید به [مستندات رسمی Semantic Kernel](https://github.com/microsoft/semantic-kernel) مراجعه کنید.

---

## حافظه (Memory)

توی این مثال، حافظه به عنوان یک جزء کلیدی جهت بهبود پاسخ‌دهی معرفی می‌شه.

### ساختار حافظه:

- VolatileMemoryStore: از یک حافظه ناپایدار (volatile) استفاده می‌کنه که تنها در حافظه موقتی ذخیره می‌شه.  
- SemanticTextMemory: این کلاس وظیفه نگهداری اطلاعات متنی به همراه embeddingهای رو بر عهده داره.

### چرخه زندگی (Lifecycle) حافظه در جریان چت:

1. ایجاد حافظه: حافظه با استفاده از سرویس embedding ساخته می‌شه.  
2. ذخیره‌سازی اطلاعات: نرخ‌های ارز استخراج شده از یک وبسایت (مثل bonbast.org) رو به حافظه اضافه می‌کنیم.  
3. بازیابی اطلاعات: موقع پردازش پرسش نهایی، داده‌های مرتبط از حافظه استخراج شده و به عنوان زمینه (context) به مدل چت ارائه می‌شه.  
4. استفاده در تولید پاسخ: اطلاعات بازیابی شده همراه با پرسش اصلی توی یک prompt ترکیب شده و پاسخ نهایی از مدل تولید می‌شه.

---

## توضیح اجمالی کد

1. تنظیمات اولیه:  
     
   - سوال اصلی درباره نرخ تبدیل ۱ یورو به ریال ایران تعریف می‌شود.  
   - دو روش پاسخ‌دهی ارائه شده: مستقیم از مدل چت و سپس با استفاده از تکنیک RAG.

   

2. راه‌اندازی Kernel:  
     
   - از Kernel.CreateBuilder() استفاده شده و مدل Ollama با شناسه llama3.2:3b به عنوان سرویس چت و تولید embedding به کار گرفته شده است.

   

3. اجرای پرسش مستقیم:  
     
   - با استفاده از متد InvokePromptStreamingAsync سوال مستقیم به مدل ارسال شده و پاسخ نمایش داده می‌شود.

   

4. استفاده از حافظه معنایی و تکنیک RAG:  
     
   - سرویس embedding دریافت و حافظه معنایی (SemanticTextMemory) ساخته می‌شود.  
   - اطلاعات نرخ ارز از وبسایت استخراج و در حافظه ذخیره می‌شود.  
   - یک پلاگین حافظه (TextMemoryPlugin) ساخته و به kernel اضافه می‌شود.  
   - یک prompt ترکیبی شامل پرسش اصلی و داده‌های بازیابی شده از حافظه تهیه شده است.  
   - در نهایت، پاسخ مدل بر اساس prompt ترکیبی تولید و نمایش داده می‌شود.

---

## توضیح گام به گام کد

1. تعریف سوال:  
   سوال اصلی درباره نرخ تبدیل ۱ یورو به ریال ایران، در مقایسه با یک یورو است.  
     
2. راه‌اندازی Builder و افزودن سرویس‌ها:  
     
   - با استفاده از ()Kernel.CreateBuilder سرویس‌های مربوط به چت و تولید embedding به Kernel اضافه می‌شن.  
   - مدل Ollama (با آدرس محلی) برای پردازش چت انتخاب می‌شه.

   

3. اجرای پاسخ‌دهی مستقیم:  
     
   - با فراخوانی kernel.InvokePromptStreamingAsync مدل، پاسخ رو به صورت streaming ارسال می‌کنه.

   

4. آماده‌سازی حافظه:  
     
   - سرویس embedding آماده‌ می‌شه و یک حافظه با استفاده از VolatileMemoryStore ساخته می‌شه.  
   - اطلاعات نرخ ارز از وبسایت استخراج (با استفاده از کتابخونه HtmlAgilityPack) و پردازش می‌شه.  
   - هر نرخ ارز به عنوان یک مدخل در حافظه ذخیره می‌شه.

   

5. استفاده از حافظه در تولید پاسخ (RAG):  
     
   - یک پلاگین حافظه ساخته و به Kernel وارد می‌شه.  
   - یک prompt جدید تهیه می‌شود که شامل پرسش و داده‌های بازیابی شده از حافظه (با کلید {{Recall}}) است.  
   - پارامترهای مورد نیاز مانند نام مجموعه حافظه و جفت ارز استخراج می‌شن.  
   - پاسخ نهایی بر اساس prompt ترکیبی به‌صورت جریان ارسال و نمایش داده می‌شه.

این مثال به خوبی نشون می‌ده چطوری می‌تونیم با استفاده از قابلیت‌های Semantic Kernel و حافظه معنایی، یک سیستم پرسش و پاسخ به‌روز و دقیق راه‌اندازی کنیم.

---

## منابع و اطلاعات بیشتر

برای کسب اطلاعات به‌روز در خصوص Semantic Kernel و مفاهیم حافظه معنایی، پیشنهاد می‌کنم به [مستندات رسمی Microsoft Semantic Kernel](https://github.com/microsoft/semantic-kernel) مراجعه کنید.

---

</div>
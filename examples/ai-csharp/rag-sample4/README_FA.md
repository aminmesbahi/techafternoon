<div dir="rtl">

# مثال پیاده‌سازی RAG با استفاده از Semantic Kernel و PostgreSQL برای پردازش نرخ ارز

در این مثال، نحوه پیاده‌سازی یک سیستم هوشمند برای استعلام نرخ ارز با استفاده از **Semantic Kernel** نشان داده می‌شود. این مثال دو رویکرد را مقایسه می‌کند: پرسش مستقیم از مدل زبانی (`llama3.2:3b`) و پاسخ بهبود یافته با استفاده از تکنیک **RAG (Retrieval Augmented Generation)** همراه با ذخیره‌سازی برداری PostgreSQL.

---

## معرفی Semantic Kernel

**Semantic Kernel** یک SDK سبک است که مدل‌های زبانی بزرگ (LLMs) را از طریق پلاگین‌ها در برنامه‌ها ادغام می‌کند. ویژگی‌های کلیدی آن عبارتند از:
- **تکمیل گفتگو (Chat Completion):** امکان پاسخ‌های تعاملی مبتنی بر مکالمه را فراهم می‌کند.
- **تعبیه متن (Embeddings):** تبدیل داده‌های متنی به نمایش‌های برداری برای جستجوی معنایی.
- **پلاگین‌ها:** گسترش عملکرد با اجزای اضافی مانند **حافظه معنایی (Semantic Memory)**.

برای اطلاعات بیشتر، لطفاً به [مستندات رسمی Semantic Kernel](https://github.com/microsoft/semantic-kernel) مراجعه کنید.

---

## درک RAG با pgvector

در این مثال، RAG با استفاده از PostgreSQL همراه با افزونه pgvector پیاده‌سازی شده است:

### ساختار حافظه:
- **PostgresMemoryStore:** یک پایگاه داده برداری پایدار با استفاده از PostgreSQL با افزونه pgvector.
- **SemanticTextMemory:** سرویسی که ذخیره‌سازی و بازیابی داده‌های متنی را همراه با تعبیه‌های برداری آن‌ها مدیریت می‌کند.

### جریان پیاده‌سازی RAG:
1. **جمع‌آوری داده:** اطلاعات نرخ ارز از یک منبع خارجی (bonbast.org) دریافت می‌شود.
2. **تولید بردار:** تعبیه‌های متنی برای هر ورودی نرخ ارز ایجاد می‌شود.
3. **ذخیره‌سازی:** تعبیه‌ها و متن مربوطه در pgvector ذخیره می‌شوند.
4. **پردازش پرسش:** هنگام دریافت یک سؤال، زمینه مرتبط از پایگاه داده برداری بازیابی می‌شود.
5. **پاسخ بهبود یافته:** زمینه بازیابی شده با سؤال اصلی ترکیب می‌شود تا پاسخی دقیق‌تر تولید شود.

---

## مرور کلی کد

1. **تنظیمات اولیه:**  
   - یک سؤال درباره نرخ تبدیل یورو به ریال ایران تعریف می‌شود.
   - دو رویکرد مقایسه می‌شوند: پاسخ مستقیم LLM در مقابل پاسخ بهبود یافته با RAG.

2. **پیکربندی Kernel:**  
   - از الگوی سازنده Semantic Kernel برای راه‌اندازی سرویس‌های ضروری استفاده می‌شود.
   - Ollama به عنوان ارائه‌دهنده تکمیل گفتگو و تولید تعبیه پیکربندی می‌شود.
   - مدل `llama3.2:3b` برای هر دو سرویس مشخص شده است.

3. **پاسخ مستقیم LLM:**  
   - سؤال مستقیماً به مدل با حداقل مهندسی پرامپت ارسال می‌شود.
   - پاسخ به صورت جریانی به کنسول بازگردانده می‌شود.

4. **پیاده‌سازی RAG با pgvector:**  
   - یک اتصال PostgreSQL با افزونه pgvector فعال شده برقرار می‌شود.
   - سرویس تعبیه با اندازه بردار 3072 (مطابق با ابعاد تعبیه مدل) پیکربندی می‌شود.
   - داده‌های نرخ ارز دریافت، پردازش و در پایگاه داده برداری ذخیره می‌شوند.
   - یک قالب پرامپت تخصصی، سؤال کاربر را با زمینه بازیابی شده ترکیب می‌کند.
   - پاسخ بهبود یافته از دانش LLM و داده‌های خاص بازیابی شده بهره می‌برد.

---

## راهنمای پیاده‌سازی گام به گام

1. **پیش‌نیازها:**
   - PostgreSQL با افزونه pgvector نصب شده
   - Ollama در حال اجرا محلی با مدل `llama3.2:3b`
   - .NET SDK

2. **تنظیم پایگاه داده:**
   ```sql
   CREATE EXTENSION vector;
   CREATE DATABASE ragdb;
   CREATE USER user WITH PASSWORD 'pass';
   GRANT ALL PRIVILEGES ON DATABASE ragdb TO user;
   ```

3. **جریان اجرای کد:**
   - برنامه ابتدا یک پاسخ مستقیم از LLM را نمایش می‌دهد.
   - پس از تأیید کاربر (فشردن Enter)، رویکرد RAG را نشان می‌دهد.
   - نرخ‌های ارز دریافت و در پایگاه داده برداری PostgreSQL ذخیره می‌شوند.
   - یک قالب پرامپت تخصصی، سؤال را با زمینه بازیابی شده ترکیب می‌کند.
   - پاسخ بهبود یافته تولید و نمایش داده می‌شود.

4. **اجزای کلیدی:**
   - **PostgresMemoryStore:** مدیریت ذخیره‌سازی برداری در PostgreSQL.
   - **SemanticTextMemory:** مدیریت ذخیره‌سازی و بازیابی اطلاعات.
   - **TextMemoryPlugin:** ادغام قابلیت‌های حافظه با هسته.
   - **OllamaPromptExecutionSettings:** پیکربندی پارامترهای اجرای پرامپت.

---

## ادغام دقیق حافظه

کلید این پیاده‌سازی، نحوه ادغام حافظه است:

```csharp
// ایجاد فروشگاه حافظه pgvector
var postgresMemoryStore = new PostgresMemoryStore(
    connectionString: connectionString,
    schema: schema,
    vectorSize: 3072
);

var memory = new SemanticTextMemory(postgresMemoryStore, embeddingGenerator);
var memoryPlugin = new TextMemoryPlugin(memory);
kernel.ImportPluginFromObject(memoryPlugin);
```

این یک سیستم حافظه معنایی ایجاد می‌کند که:
1. تعبیه‌های برداری را در PostgreSQL ذخیره می‌کند
2. از مدل Ollama برای تولید تعبیه‌ها استفاده می‌کند
3. عملیات حافظه را از طریق پلاگین‌ها برای هسته در دسترس قرار می‌دهد

هنگامی که پرامپت پردازش می‌شود، جایگزین `{{Recall}}` به طور خودکار با اطلاعات مرتبط از فروشگاه حافظه پر می‌شود.

---

## ملاحظات عملکرد

- **ابعاد بردار:** این مثال از بردارهای 3072 بعدی استفاده می‌کند که با اندازه تعبیه مدل `llama3.2:3b` مطابقت دارد.
- **آستانه ارتباط:** یک امتیاز ارتباط حداقل 0.1 تنظیم شده است تا اطمینان حاصل شود که فقط داده‌های معنادار بازیابی می‌شوند.
- **تشخیص جفت ارز:** سیستم جفت‌های ارز خاص را در سؤال شناسایی می‌کند تا دقت بازیابی را بهبود بخشد.

---

## منابع اضافی

- [مخزن GitHub مایکروسافت Semantic Kernel](https://github.com/microsoft/semantic-kernel)
- [مستندات PostgreSQL pgvector](https://github.com/pgvector/pgvector)
- [پروژه Ollama](https://ollama.ai/)

---

</div>